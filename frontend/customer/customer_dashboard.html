<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Customer Dashboard</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== "customer") {
      alert("Access denied. Redirecting to login.");
      window.location.href = "../login.html";
    }
  </script>

  <div class="dashboard-header">
    <h1>Welcome, <span id="userName"></span>! üëã</h1>
    <div class="header-actions">
      <button class="cart-btn" onclick="toggleCart()">
        üõí Cart (<span id="cartCount">0</span>)
      </button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Cart Sidebar -->
  <div id="cartSidebar" class="cart-sidebar">
    <div class="cart-header">
      <h3>Your Cart</h3>
      <button onclick="toggleCart()" class="close-cart">√ó</button>
    </div>
    <div id="cartItems"></div>
    <div class="cart-footer">
      <div class="cart-total">Total: $<span id="cartTotal">0.00</span></div>
      <button class="checkout-btn" onclick="showCheckout()">Checkout</button>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="modal">
    <div class="modal-content">
      <h3>Checkout</h3>
      <form id="checkoutForm">
        <input type="text" id="deliveryAddress" placeholder="Delivery Address" required>
        <input type="tel" id="phone" placeholder="Phone Number" required>
        <textarea id="notes" placeholder="Special instructions (optional)"></textarea>
        <div class="modal-actions">
          <button type="button" onclick="closeCheckout()">Cancel</button>
          <button type="submit">Place Order</button>
        </div>
      </form>
    </div>
  </div>

  <section>
    <h2>üçΩÔ∏è Browse Restaurants</h2>
    <div id="restaurants">
      <div class="loading"></div>
    </div>
  </section>

  <section>
    <h2>üìã My Orders</h2>
    <div id="orders">
      <p class="text-center">Loading orders...</p>
    </div>
  </section>

  <script>
    const API_BASE = "http://localhost/food%20delivery%20system/backend";
    let cart = [];

    // Initialize
    document.getElementById('userName').textContent = user.name;
    loadRestaurants();
    loadOrders();
    loadCart();

    async function loadRestaurants() {
      try {
        const res = await fetch(`${API_BASE}/customer/get_restaurents.php`);
        const data = await res.json();
        const container = document.getElementById("restaurants");
        
        if (data.length === 0) {
          container.innerHTML = '<p class="text-center">No restaurants available.</p>';
          return;
        }
        
        container.innerHTML = data.map(r =>
          `<div class="restaurant-card">
             <div class="restaurant-info">
               <h3>${r.name}</h3>
               <p>${r.description || 'Delicious food awaits!'}</p>
             </div>
             <button class="btn-secondary" onclick="viewMenu(${r.restaurant_id})">View Menu</button>
           </div>`
        ).join("");
      } catch (error) {
        document.getElementById("restaurants").innerHTML = '<p class="text-center">Error loading restaurants.</p>';
      }
    }

    async function viewMenu(restaurantId) {
      try {
        const res = await fetch(`${API_BASE}/restaurant/get_menu.php?restaurant_id=${restaurantId}`);
        const menu = await res.json();
        
        if (menu.length === 0) {
          alert("No menu items available.");
          return;
        }
        
        const menuHtml = menu.map(m => 
          `<div class="menu-item">
             <div class="menu-item-info">
               <h4>${m.name}</h4>
               <p>${m.description || ''}</p>
             </div>
             <div class="menu-item-actions">
               <span class="menu-item-price">$${m.price}</span>
               <button onclick="addToCart(${m.menu_item_id}, '${m.name}', ${m.price})" class="add-to-cart-btn">Add to Cart</button>
             </div>
           </div>`
        ).join("");
        
        showModal('Menu', menuHtml);
      } catch (error) {
        alert("Error loading menu.");
      }
    }

    async function addToCart(menuItemId, name, price) {
      const formData = new FormData();
      formData.append('customer_id', user.user_id);
      formData.append('menu_item_id', menuItemId);
      formData.append('quantity', 1);

      try {
        const res = await fetch(`${API_BASE}/customer/add_to_cart.php`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        
        if (result.success) {
          loadCart();
          showNotification('Item added to cart!');
        } else {
          alert(result.message);
        }
      } catch (error) {
        alert("Error adding to cart.");
      }
    }

    async function loadCart() {
      try {
        const res = await fetch(`${API_BASE}/customer/get_cart.php?customer_id=${user.user_id}`);
        cart = await res.json();
        updateCartDisplay();
      } catch (error) {
        console.error("Error loading cart:", error);
      }
    }

    function updateCartDisplay() {
      const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
      const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      
      document.getElementById('cartCount').textContent = cartCount;
      document.getElementById('cartTotal').textContent = cartTotal.toFixed(2);
      
      const cartItems = document.getElementById('cartItems');
      if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-center">Your cart is empty</p>';
        return;
      }
      
      cartItems.innerHTML = cart.map(item =>
        `<div class="cart-item">
           <div class="cart-item-info">
             <h4>${item.name}</h4>
             <p>${item.restaurant_name}</p>
             <span class="cart-item-price">$${item.price} x ${item.quantity}</span>
           </div>
           <button onclick="removeFromCart(${item.cart_id})" class="remove-btn">√ó</button>
         </div>`
      ).join("");
    }

    async function removeFromCart(cartId) {
      const formData = new FormData();
      formData.append('cart_id', cartId);

      try {
        const res = await fetch(`${API_BASE}/customer/remove_from_cart.php`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        
        if (result.success) {
          loadCart();
        } else {
          alert(result.message);
        }
      } catch (error) {
        alert("Error removing item.");
      }
    }

    async function loadOrders() {
      try {
        const res = await fetch(`${API_BASE}/customer/get_orders.php?customer_id=${user.user_id}`);
        const orders = await res.json();
        const container = document.getElementById("orders");
        
        if (orders.length === 0) {
          container.innerHTML = '<p class="text-center">No orders yet.</p>';
          return;
        }
        
        container.innerHTML = orders.map(o => 
          `<div class="order-item">
             <div class="order-info">
               <h4>${o.restaurant_name}</h4>
               <p>Total: $${o.total_amount}</p>
               <small>${new Date(o.created_at).toLocaleDateString()}</small>
             </div>
             <span class="order-status status-${o.status}">${o.status}</span>
           </div>`
        ).join("");
      } catch (error) {
        document.getElementById("orders").innerHTML = '<p class="text-center">Error loading orders.</p>';
      }
    }

    function toggleCart() {
      const sidebar = document.getElementById('cartSidebar');
      sidebar.classList.toggle('active');
    }

    function showCheckout() {
      if (cart.length === 0) {
        alert('Your cart is empty!');
        return;
      }
      document.getElementById('checkoutModal').style.display = 'flex';
    }

    function closeCheckout() {
      document.getElementById('checkoutModal').style.display = 'none';
    }

    document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData();
      formData.append('customer_id', user.user_id);
      formData.append('delivery_address', document.getElementById('deliveryAddress').value);
      formData.append('phone', document.getElementById('phone').value);
      formData.append('notes', document.getElementById('notes').value);

      try {
        const res = await fetch(`${API_BASE}/customer/place_order.php`, {
          method: 'POST',
          body: formData
        });
        const result = await res.json();
        
        if (result.success) {
          alert('Order placed successfully!');
          closeCheckout();
          loadCart();
          loadOrders();
          document.getElementById('checkoutForm').reset();
        } else {
          alert(result.message);
        }
      } catch (error) {
        alert("Error placing order.");
      }
    });

    function showModal(title, content) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      modal.innerHTML = `
        <div class="modal-content">
          <div class="modal-header">
            <h3>${title}</h3>
            <button onclick="this.closest('.modal').remove()" class="close-btn">√ó</button>
          </div>
          <div class="modal-body">${content}</div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function showNotification(message) {
      const notification = document.createElement('div');
      notification.className = 'notification';
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "../login.html";
    }
  </script>
</body>
</html>